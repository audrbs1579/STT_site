<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 음성 텍스트 변환기</title>
    <!-- Tailwind CSS CDN 추가 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 로딩 스피너를 위한 CSS */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-12">
    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-6">
        
        <!-- 헤더 -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">AI 음성 텍스트 변환기</h1>
            <p class="text-gray-500 mt-2">오디오 파일을 업로드하여 시간대별 텍스트로 변환하세요.</p>
        </div>

        <!-- 파일 업로드 영역 -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 transition-colors" id="dropZone">
            <input type="file" id="audioFile" accept="audio/*" class="hidden">
            <p class="text-gray-500" id="dropZoneText">여기에 파일을 드래그하거나 클릭하여 선택하세요.</p>
            <p class="text-sm text-gray-400 mt-2">지원 형식: MP3, WAV, M4A 등</p>
        </div>

        <!-- 업로드 버튼 -->
        <button onclick="uploadFile()" id="uploadButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-all duration-300 disabled:bg-gray-400">
            업로드 및 변환 시작
        </button>

        <!-- 상태 및 결과 표시 영역 -->
        <div id="status" class="text-center space-y-4">
            <div id="loader" class="loader mx-auto hidden"></div>
            <p id="statusMessage" class="text-gray-600"></p>
        </div>

        <!-- 변환 결과 카드 -->
        <div id="resultCard" class="bg-gray-50 p-6 rounded-lg border border-gray-200 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">시간대별 변환 결과</h2>
            <div id="resultText" class="space-y-2">
                <!-- 타임스탬프와 텍스트가 여기에 동적으로 추가됩니다. -->
            </div>
        </div>

    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const audioFile = document.getElementById('audioFile');
        const dropZoneText = document.getElementById('dropZoneText');
        const uploadButton = document.getElementById('uploadButton');
        const loader = document.getElementById('loader');
        const statusMessage = document.getElementById('statusMessage');
        const resultCard = document.getElementById('resultCard');
        const resultText = document.getElementById('resultText');

        dropZone.addEventListener('click', () => audioFile.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-500', 'bg-blue-50'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            if (e.dataTransfer.files.length) {
                audioFile.files = e.dataTransfer.files;
                updateDropZoneText();
            }
        });
        audioFile.addEventListener('change', updateDropZoneText);

        function updateDropZoneText() {
            if (audioFile.files.length > 0) {
                dropZoneText.textContent = `선택된 파일: ${audioFile.files[0].name}`;
                dropZone.classList.add('border-green-500');
            } else {
                dropZoneText.textContent = '여기에 파일을 드래그하거나 클릭하여 선택하세요.';
                dropZone.classList.remove('border-green-500');
            }
        }

        async function uploadFile() {
            const file = audioFile.files[0];
            if (!file) {
                showStatus('파일을 먼저 선택해주세요.', 'error');
                return;
            }
            setLoadingState(true);
            showStatus('파일을 업로드하고 있습니다...', 'info');
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch('/api/UploadAndTranscribe', { method: 'POST', body: formData });
                showStatus('파일을 분석하고 텍스트로 변환 중입니다... (최대 5분 소요)', 'info');
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || `서버 오류: ${response.status}`);
                }
                displayResult(result);
            } catch (error) {
                console.error('Error:', error);
                showStatus(`오류 발생: ${error.message}`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * API 응답을 받아 시간대별 텍스트 UI를 생성합니다.
         * @param {object} data - Azure AI Speech API의 JSON 응답 객체
         */
        function displayResult(data) {
            resultText.innerHTML = ''; // 이전 결과 초기화

            const phrases = data?.recognizedPhrases;

            if (phrases && phrases.length > 0) {
                // 타임스탬프(tick)를 '분:초.밀리초' 형식으로 변환하는 함수
                const formatTicks = (ticks) => {
                    const seconds = (ticks || 0) / 10000000;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    const pad = (num) => num.toString().padStart(2, '0');
                    const milliseconds = Math.round((remainingSeconds - Math.floor(remainingSeconds)) * 1000).toString().padStart(3, '0');
                    return `${pad(minutes)}:${pad(Math.floor(remainingSeconds))}.${milliseconds}`;
                };

                phrases.forEach(phrase => {
                    const nBest = phrase.nBest?.[0];
                    if (!nBest) return;

                    const startTime = formatTicks(nBest.offsetInTicks);
                    const text = nBest.display;

                    // 각 텍스트 라인을 위한 UI 요소 생성
                    const timelineBlock = document.createElement('div');
                    timelineBlock.className = 'flex items-start space-x-3 p-2 rounded-md hover:bg-gray-100';

                    const timestampEl = document.createElement('div');
                    timestampEl.className = 'w-24 text-right font-mono text-sm text-blue-600 py-1';
                    timestampEl.textContent = startTime;

                    const textEl = document.createElement('div');
                    textEl.className = 'flex-1 text-gray-800 py-1 border-l-2 border-gray-200 pl-3';
                    textEl.textContent = text;

                    timelineBlock.appendChild(timestampEl);
                    timelineBlock.appendChild(textEl);
                    resultText.appendChild(timelineBlock);
                });

                if (resultText.childElementCount === 0) {
                    showEmptyResultMessage();
                } else {
                    showStatus('변환이 완료되었습니다!', 'success');
                }
            } else {
                showEmptyResultMessage();
            }
            resultCard.classList.remove('hidden');
        }
        
        function showEmptyResultMessage() {
            resultText.innerHTML = `<p class="text-gray-500">오디오 파일에서 인식 가능한 음성을 찾을 수 없습니다.<br><br>- 파일에 소리가 포함되어 있는지 확인해주세요.<br>- 너무 시끄러운 환경의 음성인지 확인해주세요.</p>`;
            showStatus('분석 완료: 변환할 음성 없음', 'warning');
        }

        function setLoadingState(isLoading) {
            uploadButton.disabled = isLoading;
            loader.classList.toggle('hidden', !isLoading);
            resultCard.classList.toggle('hidden', true);
        }

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            const colorClasses = {
                error: 'text-red-500',
                success: 'text-green-500',
                warning: 'text-yellow-600',
                info: 'text-gray-600'
            };
            statusMessage.className = `transition-colors duration-300 ${colorClasses[type] || colorClasses.info}`;
        }
    </script>
</body>
</html>
